<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debian/Ubuntuç¦»çº¿åŒ…ä¸‹è½½</title>
    <script src="https://cdn.staticfile.net/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.staticfile.net/axios/1.6.0/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [v-cloak] {
            display: none !important;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }

        .terminal {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Menlo', monospace;
            padding: 1rem;
            border-radius: 0.5rem;
            height: 250px;
            overflow-y: auto;
            border: 1px solid #333;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .log-info {
            color: #9cdcfe;
        }

        .log-warn {
            color: #ce9178;
        }

        .log-success {
            color: #6a9955;
            font-weight: bold;
        }

        .log-cache {
            color: #dcdcaa;
            font-weight: bold;
        }

        .log-time {
            color: #569cd6;
            margin-right: 10px;
            opacity: 0.8;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center py-10">

    <div id="app" v-cloak class="bg-white p-8 rounded-lg shadow-xl w-full max-w-5xl mx-4">
        <div class="text-center mb-8 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">ğŸ“¦ Linux ç¦»çº¿å®‰è£…åŒ…</h1>
            <p class="text-gray-500 mt-2 text-sm">
                é€‚é… Debian/Ubuntu
                <span class="text-green-600 font-bold">å¸¸ç”¨åŒ…æ°¸ä¹…ç¼“å­˜</span> /
                <span class="text-orange-500 font-bold">è‡ªå®šä¹‰åŒ…ä¿ç•™3å¤©</span>
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="space-y-6">
                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-sm uppercase">1. ç›®æ ‡ç³»ç»Ÿ</label>
                    <select v-model="form.distro"
                        class="block w-full bg-gray-50 border border-gray-300 py-3 px-4 rounded transition">
                        <optgroup label="Ubuntu (æœ€æ–°/å¼€å‘)">
                            <option value="ubuntu_26_series">Ubuntu 26 Series (Rolling)</option>
                            <option value="ubuntu_25_10">Ubuntu 25.10 (Plucky)</option>
                            <option value="ubuntu_24_04">Ubuntu 24.04 LTS (Noble)</option>
                        </optgroup>
                        <optgroup label="Ubuntu (ç¨³å®š/æ—§ç‰ˆ)">
                            <option value="ubuntu_22_04">Ubuntu 22.04 LTS (Jammy)</option>
                            <option value="ubuntu_18_04">Ubuntu 18.04 LTS (Bionic)</option>
                            <option value="ubuntu_16_04">Ubuntu 16.04 LTS (Xenial)</option>
                        </optgroup>
                        <optgroup label="Debian">
                            <option value="debian_13">Debian 13 (Trixie)</option>
                            <option value="debian_12">Debian 12 (Bookworm)</option>
                            <option value="debian_11">Debian 11 (Bullseye)</option>
                        </optgroup>
                    </select>
                </div>

                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-sm uppercase">2. ç›®æ ‡æ¶æ„</label>
                    <div class="flex space-x-4">
                        <label class="flex-1 border rounded p-3 cursor-pointer hover:bg-blue-50"
                            :class="{'border-blue-500 bg-blue-50': form.arch === 'amd64'}">
                            <input type="radio" value="amd64" v-model="form.arch" class="hidden">
                            <div class="font-bold">x86_64</div>
                        </label>
                        <label class="flex-1 border rounded p-3 cursor-pointer hover:bg-blue-50"
                            :class="{'border-blue-500 bg-blue-50': form.arch === 'arm64'}">
                            <input type="radio" value="arm64" v-model="form.arch" class="hidden">
                            <div class="font-bold">aarch64</div>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-sm uppercase">
                        3. è‡ªå®šä¹‰åŒ…å
                        <span class="text-xs text-orange-500 normal-case ml-2">(3å¤©è‡ªåŠ¨æ¸…ç†)</span>
                    </label>
                    <input v-model="form.customPackages" type="text" placeholder="ä¾‹å¦‚: nginx htop (ç©ºæ ¼åˆ†éš”)"
                        class="block w-full bg-gray-50 border border-gray-300 rounded py-3 px-4">
                </div>

                <button @click="submitTask" :disabled="loading"
                    :class="loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'"
                    class="w-full text-white font-bold py-3 rounded mt-4 flex justify-center items-center shadow-lg transition">
                    {{ loading ? 'å¤„ç†ä¸­...' : 'å¼€å§‹æ„å»º' }}
                </button>
            </div>

            <div class="flex flex-col h-full">
                <label class="block text-gray-700 font-bold mb-2 text-sm uppercase">
                    å¸¸ç”¨ç»„ä»¶å¿«æ·é€‰
                    <span class="text-xs text-green-600 normal-case ml-2">(æ°¸ä¹…ç¼“å­˜)</span>
                </label>

                <div
                    class="bg-white border border-gray-200 rounded-lg p-4 flex-grow overflow-y-auto max-h-64 shadow-inner custom-scroll mb-6">
                    <label v-for="pkg in commonPackages" :key="pkg.name"
                        class="flex items-center space-x-3 mb-3 cursor-pointer hover:bg-gray-50 p-2 rounded transition group select-none">
                        <input type="checkbox" :value="pkg.val" v-model="form.selectedCommon"
                            class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="text-sm font-medium">{{ pkg.name }}</span>
                    </label>
                </div>

                <div class="mt-auto">
                    <div v-if="!taskStatus"
                        class="w-full py-3 text-center text-gray-400 text-sm border border-dashed border-gray-300 rounded bg-gray-50 select-none">
                        ç­‰å¾…ä»»åŠ¡...</div>
                    <div v-if="taskStatus === 'processing'"
                        class="w-full py-3 flex justify-center items-center bg-blue-50 text-blue-700 rounded border border-blue-200 animate-pulse font-medium select-none">
                        æ­£åœ¨äº‘ç«¯æ„å»º...
                    </div>
                    <a v-if="taskStatus === 'completed'" :href="downloadUrl"
                        class="block w-full bg-green-600 hover:bg-green-700 text-white text-center font-bold py-3 rounded shadow-lg flex justify-center items-center hover:scale-105 transition">
                        <span v-if="isCached" class="mr-2">âš¡</span> ä¸‹è½½ç¦»çº¿åŒ… (.tar.gz)
                    </a>
                    <div v-if="taskStatus === 'failed'"
                        class="w-full py-3 text-center bg-red-100 text-red-700 font-bold rounded border border-red-200 cursor-not-allowed select-none">
                        âŒ æ„å»ºå¤±è´¥</div>
                </div>
            </div>
        </div>

        <div class="mt-8">
            <label class="block text-gray-700 font-bold text-sm uppercase tracking-wide mb-2">æ§åˆ¶å°æ—¥å¿—</label>
            <div class="terminal" id="logBox">
                <div v-if="logs.length === 0" class="text-gray-500 italic text-center mt-20 opacity-50">ç­‰å¾…ä»»åŠ¡æäº¤...</div>
                <div v-for="(log, index) in logs" :key="index">
                    <span class="log-time">[{{ log.time }}]</span>
                    <span :class="log.class">{{ log.msg }}</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, reactive, ref, nextTick } = Vue;

        createApp({
            setup() {
                const loading = ref(false), taskStatus = ref(null), downloadUrl = ref(''), logs = ref([]), isCached = ref(false);
                let pollInterval = null;
                const form = reactive({ distro: 'ubuntu_24_04', arch: 'amd64', selectedCommon: [], customPackages: '' });
                const commonPackages = [
                    { name: 'Docker Engine (å« Compose)', val: 'docker.io docker-compose-v2' },
                    { name: 'OpenSSH Server', val: 'openssh-server' },
                    { name: 'Vim ç¼–è¾‘å™¨', val: 'vim' },
                    { name: 'Net Tools (ifconfig)', val: 'net-tools' },
                    { name: 'Curl & Wget', val: 'curl wget' },
                    { name: 'Git ç‰ˆæœ¬æ§åˆ¶', val: 'git' },
                    { name: 'Build Essential', val: 'build-essential' },
                    { name: 'Python3 pip', val: 'python3-pip' },
                    { name: 'Unzip / Zip', val: 'unzip zip' },
                    { name: 'MariaDB Client', val: 'mariadb-client' },
                    { name: 'Htop ç›‘æ§å·¥å…·', val: 'htop' },
                    { name: 'Jq JSONè§£æ', val: 'jq' },
                ];

                const addLog = (msg, type = 'log-info') => {
                    logs.value.push({ time: new Date().toLocaleTimeString('en-GB'), msg, class: type });
                    nextTick(() => { const el = document.getElementById('logBox'); if (el) el.scrollTop = el.scrollHeight; });
                };

                const submitTask = async () => {
                    if (form.selectedCommon.length === 0 && !form.customPackages.trim()) { alert("è¯·é€‰æ‹©è½¯ä»¶åŒ…"); return; }
                    loading.value = true; taskStatus.value = 'processing'; downloadUrl.value = ''; logs.value = []; isCached.value = false;
                    addLog(`åˆå§‹åŒ–: ${form.distro} | ${form.arch}`);

                    let pkgList = [...form.selectedCommon];
                    if (form.customPackages) pkgList.push(...form.customPackages.split(' '));
                    pkgList = [...new Set(pkgList.join(' ').split(/\s+/).filter(p => p))];

                    try {
                        const res = await axios.post('/api/create_task', { distro: form.distro, arch: form.arch, packages: pkgList });
                        if (res.data.status === 'cached') {
                            addLog('âš¡ å‘½ä¸­é«˜é€Ÿç¼“å­˜ï¼æ— éœ€æ„å»ºã€‚', 'log-cache');
                            taskStatus.value = 'completed'; downloadUrl.value = res.data.download_url; isCached.value = true; loading.value = false;
                        } else {
                            addLog(`æäº¤æˆåŠŸ ID: ${res.data.task_id}ï¼Œå¼€å§‹æ„å»º...`, 'log-success');
                            pollStatus(res.data.task_id);
                        }
                    } catch (e) { addLog(`é”™è¯¯: ${e.message}`, 'log-warn'); loading.value = false; taskStatus.value = 'failed'; }
                };

                const pollStatus = (taskId) => {
                    let fails = 0;
                    pollInterval = setInterval(async () => {
                        try {
                            const res = await axios.get(`/api/check/${taskId}`);
                            const data = res.data;

                            if (data.status === 'completed') {
                                addLog('ğŸ‰ æ„å»ºå®Œæˆï¼', 'log-success');
                                taskStatus.value = 'completed'; downloadUrl.value = data.download_url; clearInterval(pollInterval); loading.value = false;
                            } else if (data.status === 'failed') {
                                const errorDetail = data.detail || "æœªçŸ¥é”™è¯¯";
                                addLog('âŒ æ„å»ºå¤±è´¥', 'log-warn');
                                // å°†é”™è¯¯ä¿¡æ¯åˆ†è¡Œæ˜¾ç¤ºï¼Œä½¿å…¶å¯è¯»
                                errorDetail.split('\n').forEach(line => {
                                    if (line.trim() && !line.includes('Command') && !line.includes('exit status')) {
                                        addLog(`> ${line}`, 'log-warn');
                                    }
                                });
                                taskStatus.value = 'failed'; clearInterval(pollInterval); loading.value = false;
                            } else {
                                const c = data.files_downloaded || 0;
                                if (c > 0 && !logs.value.at(-1)?.msg.includes(c)) addLog(`ğŸ“¥ ä¸‹è½½ä¸­... å·²ç¼“å­˜ ${c} ä¸ªæ–‡ä»¶`);
                            }
                        } catch (e) { if (++fails > 10) { addLog('æ— æ³•è¿æ¥æœåŠ¡å™¨', 'log-warn'); clearInterval(pollInterval); } }
                    }, 2000);
                };
                return { form, commonPackages, submitTask, loading, taskStatus, downloadUrl, logs, isCached };
            }
        }).mount('#app');
    </script>
</body>

</html>